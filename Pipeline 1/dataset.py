import os, numpy as np, nibabel as nib, cv2, torchfrom torch.utils.data import Datasetclass BraTS2DSmartDataset(Dataset):    def __init__(self, root_dir, phase, img_size, slices_per_patient, target_count):        self.root_dir = root_dir        self.phase = phase        self.img_size = img_size        self.slices_per_patient = slices_per_patient        all_ids = [            d for d in os.listdir(root_dir)            if os.path.isdir(os.path.join(root_dir, d)) and "BraTS2021" in d        ]        np.random.shuffle(all_ids)          # ⭐ المهم        self.patient_ids = all_ids[:target_count]        print(f"[{phase}] Using {len(self.patient_ids)} patients")    def __len__(self):        return len(self.patient_ids) * self.slices_per_patient    def find_nii(self, pdir, key):        for f in os.listdir(pdir):            if key in f and f.endswith((".nii", ".nii.gz")):                return os.path.join(pdir, f)        raise FileNotFoundError(key)    def __getitem__(self, idx):        patient_id = self.patient_ids[idx // self.slices_per_patient]        pdir = os.path.join(self.root_dir, patient_id)        seg = nib.load(self.find_nii(pdir, "seg")).get_fdata()        z = np.random.randint(seg.shape[2])        mask = seg[..., z]        mask[mask == 4] = 3        imgs = []        for m in ["flair", "t1", "t1ce", "t2"]:            img = nib.load(self.find_nii(pdir, m)).get_fdata()[..., z]            imgs.append(img)        x = np.stack(imgs, -1)        x = cv2.resize(x, (self.img_size, self.img_size))        mask = cv2.resize(mask, (self.img_size, self.img_size), interpolation=cv2.INTER_NEAREST)        return torch.tensor(x).permute(2,0,1).float(), torch.tensor(mask).long()